generator client {
  provider = "prisma-client-js"
}

// datasource db {
//   provider = "postgresql"
//   url      = "postgresql://postgres:postgres@localhost:5432/image_sharing?schema=public"
// }

datasource db {
  provider = "sqlite"
}


enum PrivacyLevel {
  private
  friends
  public
}

enum UserRole {
  user
  moderator
  admin
}

model User {
  id              String       @id @default(uuid())
  email           String       @unique
  passwordHash    String?      @map("password_hash")
  name            String?
  bio             String?
  avatarUrl       String?      @map("avatar_url")
  googleId        String?      @unique @map("google_id")
  defaultPrivacy  PrivacyLevel @default(private) @map("default_privacy")
  role            UserRole     @default(user)
  hasOnboarded    Boolean      @default(false) @map("has_onboarded")
  privacySettings Json?        @map("privacy_settings")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  deletedAt       DateTime?    @map("deleted_at")

  @@map("users")
  refreshTokens   RefreshToken[]
  memories        Memory[]
  
  // Social Graph
  followers       Follow[]     @relation("followers")
  following       Follow[]     @relation("following")
  followerCount   Int          @default(0) @map("follower_count")
  followingCount  Int          @default(0) @map("following_count")
  
  // Social Posts & Interactions
  posts           Post[]
  likes           Like[]
  comments        Comment[]
  uploads         Media[]
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String   @map("follower_id")
  follower    User     @relation("following", fields: [followerId], references: [id], onDelete: Cascade)
  followingId String   @map("following_id")
  following   User     @relation("followers", fields: [followingId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([followerId, followingId])
  @@map("follows")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique // Hashed token
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime @map("expires_at")
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("refresh_tokens")
  @@index([userId])
}

enum MemoryType {
  voice
  photo
  mixed
  text_only  // Pin with no media, just feeling/caption
}

// Feeling enum for emotional tagging of memories
enum Feeling {
  JOY
  MELANCHOLY
  ENERGETIC
  CALM
  INSPIRED
}

model Memory {
  id                  String       @id @default(uuid())
  userId              String       @map("user_id")
  user                User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  type                MemoryType   @default(voice)
  mediaUrl            String?      @map("media_url") // Cloudinary URL for audio/image (optional for text_only)
  contentHash         String?      @map("content_hash") // SHA-256 hash of first 4KB + size for duplicate detection
  duration            Float?       // Duration in seconds (for voice)
  latitude            Float        // GPS latitude
  longitude           Float        // GPS longitude
  privacy             PrivacyLevel @default(private)
  title               String?      // Optional title/caption
  feeling             Feeling?     // User's emotional state when capturing
  placeholderMetadata Json?        @map("placeholder_metadata") // { gradientId, feeling, timeOfDay } for client rendering
  
  // Social Interactions (Epic 6)
  likeCount           Int          @default(0) @map("like_count")
  commentCount        Int          @default(0) @map("comment_count")
  likes               Like[]
  comments            Comment[]

  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")
  deletedAt           DateTime?    @map("deleted_at")

  @@map("memories")
  @@index([userId])
  @@index([latitude, longitude])
  @@index([contentHash]) // Index for fast duplicate lookup
}

// Social Posts (Epic 5 - minimal fields for Epic 6 dependencies)
model Post {
  id           String       @id @default(uuid())
  authorId     String       @map("author_id")
  author       User         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content      String       // Text content (max 2000 chars enforced at service layer)
  privacy      PrivacyLevel @default(friends)
  likeCount    Int          @default(0) @map("like_count")
  commentCount Int          @default(0) @map("comment_count")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  deletedAt    DateTime?    @map("deleted_at")

  likes    Like[]
  comments Comment[]
  hashtags PostHashtag[]
  media    Media[]

  @@map("posts")
  @@index([authorId])
}

model Media {
  id        String   @id @default(uuid())
  url       String
  type      String   // 'image' | 'video' | 'audio'
  mimeType  String?  @map("mime_type")
  size      Int?
  caption   String?  // Per-image caption (max 200 chars, enforced at service layer)
  sortOrder Int?     @map("sort_order") // Display order in post gallery (0-based)
  
  uploaderId String  @map("uploader_id")
  uploader   User    @relation(fields: [uploaderId], references: [id])
  
  postId    String?  @map("post_id")
  post      Post?    @relation(fields: [postId], references: [id], onDelete: SetNull)
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("media")
  @@index([uploaderId])
  @@index([postId])
}

model Hashtag {
  id        String        @id @default(uuid())
  tag       String        @unique
  posts     PostHashtag[]
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  @@map("hashtags")
}

model PostHashtag {
  postId    String   @map("post_id")
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  hashtagId String   @map("hashtag_id")
  hashtag   Hashtag  @relation(fields: [hashtagId], references: [id], onDelete: Cascade)

  @@id([postId, hashtagId])
  @@map("post_hashtags")
  @@index([hashtagId])
  @@index([postId])
}

model Like {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Polymorphic-like relation (one of these must be distinct)
  postId    String?  @map("post_id")
  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  memoryId  String?  @map("memory_id")
  memory    Memory?  @relation(fields: [memoryId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, postId])
  @@unique([userId, memoryId])
  @@map("likes")
  @@index([postId])
  @@index([memoryId])
}

model Comment {
  id        String   @id @default(uuid())
  
  // Polymorphic-like relation
  postId    String?  @map("post_id")
  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  memoryId  String?  @map("memory_id")
  memory    Memory?  @relation(fields: [memoryId], references: [id], onDelete: Cascade)
  
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String   // Max 500 chars enforced at service layer
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime?@map("deleted_at")

  @@map("comments")
  @@index([postId])
  @@index([memoryId])
  @@index([userId])
}
