generator client {
  provider = "prisma-client-js"
}

// datasource db {
//   provider = "postgresql"
//   url      = "postgresql://postgres:postgres@localhost:5432/image_sharing?schema=public"
// }

datasource db {
  provider = "sqlite"
}


enum PrivacyLevel {
  private
  friends
  public
}

enum UserRole {
  user
  moderator
  admin
}

model User {
  id              String       @id @default(uuid())
  email           String       @unique
  passwordHash    String?      @map("password_hash")
  name            String?
  bio             String?
  avatarUrl       String?      @map("avatar_url")
  googleId        String?      @unique @map("google_id")
  defaultPrivacy  PrivacyLevel @default(private) @map("default_privacy")
  role            UserRole     @default(user)
  hasOnboarded    Boolean      @default(false) @map("has_onboarded")
  privacySettings Json?        @map("privacy_settings")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  deletedAt       DateTime?    @map("deleted_at")

  @@map("users")
  refreshTokens   RefreshToken[]
  memories        Memory[]
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique // Hashed token
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime @map("expires_at")
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("refresh_tokens")
  @@index([userId])
}

enum MemoryType {
  voice
  photo
  mixed
  text_only  // Pin with no media, just feeling/caption
}

// Feeling enum for emotional tagging of memories
enum Feeling {
  JOY
  MELANCHOLY
  ENERGETIC
  CALM
  INSPIRED
}

model Memory {
  id                  String       @id @default(uuid())
  userId              String       @map("user_id")
  user                User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  type                MemoryType   @default(voice)
  mediaUrl            String?      @map("media_url") // Cloudinary URL for audio/image (optional for text_only)
  contentHash         String?      @map("content_hash") // SHA-256 hash of first 4KB + size for duplicate detection
  duration            Float?       // Duration in seconds (for voice)
  latitude            Float        // GPS latitude
  longitude           Float        // GPS longitude
  privacy             PrivacyLevel @default(private)
  title               String?      // Optional title/caption
  feeling             Feeling?     // User's emotional state when capturing
  placeholderMetadata Json?        @map("placeholder_metadata") // { gradientId, feeling, timeOfDay } for client rendering
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")
  deletedAt           DateTime?    @map("deleted_at")

  @@map("memories")
  @@index([userId])
  @@index([latitude, longitude])
  @@index([contentHash]) // Index for fast duplicate lookup
}
